var BLOCK_CELL_SIZE,STAGE_X,STAGE_Y,STAGE_OFFSET_X,STAGE_OFFSET_Y,SCREEN_X,SCREEN_Y,SCREEN_BOARD_X,SCREEN_BOARD_Y,BOARD_WIDTH,BOARD_HIGH,boardStartX,boardStartY,gStage,gBackgroundLayer,gBoardLayer,gMessageLayer,gBlockGroup,gPolyGroup,wCuadromGroup,wPolyCuadrom,gCeldasOcupadas,gBoardState,gTotalBlockCell,versionString="1.3",BACKGROUND_COLOR="#ddff99",BACKGROUND_BOARD_COLOR="white",BORDER_COLOR="#666600",BORDER_STROKE_COLOR="#ffff66",BOARD_COLOR="#B7F7DE",FIXED_BLOCK_COLOR="#666666",FIXED_BORDER_COLOR=BOARD_COLOR,FOCUS_BORDER_COLOR="red",BLOCK_BORDER_COLOR="yellow",OPERATOR_COLOR="#3344FF",OPERATOR_CIRCLE_COLOR="white",FLASH_BORDER_COLOR="red",TEXT_FINISH_COLOR="#FF88EE",NEXT_BUTTON_TEXT_COLOR="#FF8800",NEXT_BUTTON_FILL_COLOR="white",NEXT_BUTTON_BORDER_COLOR="green",BLOCK_COLOR=["#FF0000","#660000","#FFFF00","#666600","#00FF00","#006600","#00FFFF","#006666","#0000FF","#000044","#FF00FF","#660066"],COLOR_BLOCK_FIJO="#112233",gBoardSizeId=0,gLevelId=1,nCuadromId=3,wCuadromPos={x:1,y:1},gBlockCellUsed=0,gBlockUsed=0,DEBUG=!0,DEBUG2=!1;function init(){if(document.onselectstart=function(){return!1},document.getElementById("checkButton").checked=!1,initLanguage(),initScreenVariable(),initScreenPosColor(),gBlockGroup=polyomino5.blockGroup,createBlockStyle(gBlockGroup),bindBlockColor(gBlockGroup),wCuadromGroup=polyomino4.blockGroup,gCeldasOcupadas=CalcCeldasOcupadas(),DEBUG2)for(var o=0;o<gCeldasOcupadas.length;o++)console.log("gCeldasOcupadas["+o+"] : "+gCeldasOcupadas[o].x+" : "+gCeldasOcupadas[o].y);createBlockStyle(wCuadromGroup);for(var e=0;e<wCuadromGroup.length;e++)wCuadromGroup[e].color="#000000";createStageLayer(),DEBUG2&&console.log("linea 201, gPolyGroup: "+gPolyGroup),playPuzzle(1)}function playPuzzle(){hiddenStartButton(),initBoardSize(gBoardSizeId,gLevelId),DEBUG2&&console.log("linea 223, playPuzzle, gPolyGroup: "+gPolyGroup),createPuzzle(1,!0),enableAllButton(),visibleAllButton()}function initBoardSize(o,e){gBoardSizeId=o,gLevelId=e}window.onload=function(){init()};var polyInitPos,levelText="Nivel",noSolutionText=" Sin solución  ",nextText="OTRO",finishText="Felicitaciones",checkSolutionShift=130;function initLanguage(){var o=getSystemLanguage();"en"!=o&&"en"!=o||(noSolutionText="No solution ",nextText="NEXT",finishText="Congratulation",levelText="Level",document.getElementById("hintsButton").value="Hint",document.getElementById("resetButton").value="Reset",document.getElementById("startButton").value="Start",checkSolutionShift=90,document.getElementById("checkboxtext").innerHTML="CHECK")}function initScreenVariable(){var o=0,e=0;"number"==typeof window.innerWidth?(o=window.innerWidth,e=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(o=document.documentElement.clientWidth,e=document.documentElement.clientHeight):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(o=document.body.clientWidth,e=document.body.clientHeight),SCREEN_X=o,SCREEN_Y=e,STAGE_X=Math.floor(.95*o),(STAGE_OFFSET_X=Math.floor((o-STAGE_X)/2))<32&&(STAGE_OFFSET_X=32),(STAGE_Y=Math.floor(.9*e))>800&&(STAGE_Y=800),STAGE_Y<300&&(STAGE_Y=300),(STAGE_OFFSET_Y=Math.floor((e-STAGE_Y)/2))<32&&(STAGE_OFFSET_Y=32),DEBUG&&console.log("SCREEN_X: "+SCREEN_X+" SCREEN_Y: "+SCREEN_Y),console.log("Parametros de pantalla"),console.log("SCREEN_X: "+SCREEN_X),console.log("SCREEN_Y: "+SCREEN_Y),console.log("STAGE_X: "+STAGE_X),console.log("STAGE_OFFSET_X: "+STAGE_OFFSET_X),console.log("STAGE_Y: "+STAGE_Y),console.log("STAGE_OFFSET_Y: "+STAGE_OFFSET_Y),console.log("BLOCK_CELL_SIZE: "+BLOCK_CELL_SIZE)}function initScreenPosColor(){document.getElementById("new").style.cssText="top:"+(Math.floor(SCREEN_Y/2)-20)+"px; left:"+(SCREEN_X-70)+"px; position: absolute;",document.getElementById("reset").style.cssText="top:"+(SCREEN_Y-56)+"px; left:20px; position: absolute;",document.getElementById("giro").style.cssText="top:"+(SCREEN_Y-56)+"px; left:110px; position: absolute;",document.getElementById("voltea").style.cssText="top:"+(SCREEN_Y-56)+"px; left:200px; position: absolute;",document.getElementById("hints").style.cssText="top:"+(SCREEN_Y-56)+"px; left:290px; position: absolute;",document.getElementById("check").style.cssText="top:"+(SCREEN_Y-48)+"px; left:380px; position: absolute;",document.body.style.background=BACKGROUND_COLOR}function bindBlockColor(o){for(var e=0;e<o.length;e++)o[e].color=BLOCK_COLOR[e]}function createStageLayer(){gStage=new Kinetic.Stage({container:"container",width:STAGE_X,height:STAGE_Y}),gBackgroundLayer=new Kinetic.Layer,gBoardLayer=new Kinetic.Layer,gMessageLayer=new Kinetic.Layer}function clearStageLayer(){gBackgroundLayer.removeChildren(),gBoardLayer.removeChildren(),gMessageLayer.removeChildren(),gStage.removeChildren()}function createPuzzle(o,e){initBoardState(8,8,0,1),DEBUG2&&console.log("linea 439, gPolyGroup: "+gPolyGroup),activePolygon()}function initBoardState(o,e,t,l){SCREEN_BOARD_X=o,SCREEN_BOARD_Y=e,BOARD_WIDTH=Math.floor(.45*SCREEN_X/SCREEN_BOARD_X)*SCREEN_BOARD_X,BOARD_HIGH=Math.floor(.7*SCREEN_Y/SCREEN_BOARD_Y)*SCREEN_BOARD_Y,BOARD_WIDTH>BOARD_HIGH?BOARD_WIDTH=BOARD_HIGH:BOARD_HIGH=BOARD_WIDTH,BLOCK_CELL_SIZE=BOARD_WIDTH/SCREEN_BOARD_X,console.log("BOARD_WIDTH, BOARD_HIGH, BLOCK_CELL_SIZE: "+BOARD_WIDTH+", "+BOARD_HIGH+", "+BLOCK_CELL_SIZE),console.log("STAGE_X, STAGE_Y: "+STAGE_X+", "+STAGE_Y),boardStartX=BLOCK_CELL_SIZE,boardStartY=Math.floor((SCREEN_Y-BOARD_HIGH)/2),console.log("boardStartX, boardStartY: "+boardStartX+", "+boardStartY),gTotalBlockCell=SCREEN_BOARD_X*SCREEN_BOARD_Y,gBlockUsed=0,gBlockCellUsed=0,clearStageLayer(),addBackgroundLayer(),addBoard2Layer(),createOperatorObject(),addOperator2Layer(),gBoardState=createBoard(SCREEN_BOARD_X,SCREEN_BOARD_Y),clearPolyInsertOrder(),randomBlock(gBlockGroup),randomBlockStyle(gBlockGroup),randomPolyInitPos(gBlockGroup.length-t),clearFixedBlock(),wAgregaCuadrominoFijo(wCuadromPos),addBlock2Layer(0),DEBUG&&dumpBoard(gBoardState),gStage.add(gBackgroundLayer),gStage.add(gBoardLayer),gStage.add(gMessageLayer),!l&&checkSolution&&checkButton(1)}function randomPolyInitPos(o){var e=Math.floor((STAGE_X-BLOCK_CELL_SIZE-BOARD_WIDTH)/4),t=Math.floor(.8*(STAGE_Y-BLOCK_CELL_SIZE)/(o/3+1));polyInitPos=[];for(var l=0;l<o;l++)polyInitPos[l]=l;for(l=0;l<o;l++){var n=Math.floor(Math.random()*o),r=polyInitPos[l];polyInitPos[l]=polyInitPos[n],polyInitPos[n]=r}for(l=0;l<o;l++){var a=polyInitPos[l];polyInitPos[l]={x:STAGE_OFFSET_X+boardStartX+BOARD_WIDTH+e*(.7+a%3),y:Math.floor(t*(1.2+a%(o/3+1)))},DEBUG&&console.log("id: "+l+", x,y: "+Object.values(polyInitPos[l]))}console.log("distance_X, distance_Y: "+e+", "+t)}function getPolyInitPos(o){return polyInitPos[o]}var gFixedPolyGroup=[];function clearFixedBlock(){gFixedPolyGroup=[]}function restoreFixedBlock2Layer(){for(var o=0;o<gFixedPolyGroup.length;o++){if(gBoardLayer.add(gFixedPolyGroup[o].poly),DEBUG)throw new Error("Error forzado para detectar los llamados!");gBlockCellUsed+=gFixedPolyGroup[o].block.length,gBlockUsed++}}function dupOpBlock(o,e,t){var l;l=[];for(var n=0;n<o.length;n++)l[n]={},l[n].x=o[n].x,l[n].y=o[n].y;if(e.leftRightFlip)for(n=0;n<l.length;n++)l[n].x=-l[n].x;if(e.upDownFlip)for(n=0;n<l.length;n++)l[n].y=-l[n].y;if(e.rotate)for(n=0;n<l.length;n++){var r=l[n].x;l[n].x=l[n].y,l[n].y=r}return t&&blockNormalization(l),l}function SolvedPos2BoardPos(o,e){var t={x:e.x,y:e.y};if(o.leftRightFlip&&(t.x=SCREEN_BOARD_X-t.x-1),o.upDownFlip&&(t.y=SCREEN_BOARD_Y-t.y-1),o.rotate){var l=t.x;t.x=t.y,t.y=l}return t}function addBackgroundLayer(){var o=Math.round(BLOCK_CELL_SIZE/4),e=Math.round(BLOCK_CELL_SIZE/6),t=Math.round(.7*BLOCK_CELL_SIZE),l=new Kinetic.Text({x:e,y:e,text:"PENTOMANÍA FATAL by Willie",fill:"green",fontSize:t,fontStyle:"bold",shadowColor:"black",shadowBlur:5,shadowOffset:[4,4],shadowOpacity:.7}),n=new Kinetic.Text({x:0,y:STAGE_Y-t/3.5,text:versionString,fill:BACKGROUND_COLOR,fontSize:t/4,fontStyle:"bold",shadowColor:"black",shadowBlur:9,shadowOffset:[2,2],shadowOpacity:.3}),r=new Kinetic.Rect({x:0,y:0,width:STAGE_X,height:STAGE_Y,fill:BACKGROUND_COLOR}),a=new Kinetic.Rect({x:boardStartX,y:boardStartY,width:SCREEN_BOARD_X*BLOCK_CELL_SIZE,height:SCREEN_BOARD_Y*BLOCK_CELL_SIZE,fill:BACKGROUND_BOARD_COLOR}),i=new Kinetic.Rect({x:boardStartX-o,y:boardStartY-o,width:SCREEN_BOARD_X*BLOCK_CELL_SIZE+2*o,height:o,fill:BORDER_COLOR}),d=new Kinetic.Rect({x:boardStartX-o,y:boardStartY,width:o,height:SCREEN_BOARD_Y*BLOCK_CELL_SIZE+o,fill:BORDER_COLOR}),c=new Kinetic.Rect({x:boardStartX+SCREEN_BOARD_X*BLOCK_CELL_SIZE,y:boardStartY,width:o,height:SCREEN_BOARD_Y*BLOCK_CELL_SIZE+o,fill:BORDER_COLOR}),s=new Kinetic.Rect({x:boardStartX-o,y:boardStartY+SCREEN_BOARD_Y*BLOCK_CELL_SIZE,width:SCREEN_BOARD_X*BLOCK_CELL_SIZE+2*o,height:o,fill:BORDER_COLOR}),u=new Kinetic.Rect({x:boardStartX-o,y:boardStartY-o,width:SCREEN_BOARD_X*BLOCK_CELL_SIZE+2*o,height:SCREEN_BOARD_Y*BLOCK_CELL_SIZE+2*o,stroke:BORDER_STROKE_COLOR,strokeWidth:2});gBackgroundLayer.add(r),gBackgroundLayer.add(l),gBackgroundLayer.add(n),gBackgroundLayer.add(a),gBackgroundLayer.add(i),gBackgroundLayer.add(d),gBackgroundLayer.add(c),gBackgroundLayer.add(s),gBackgroundLayer.add(u)}function addBoard2Layer(){var o=new Kinetic.Shape({x:boardStartX,y:boardStartY,drawFunc:function(o){for(var e=o.getContext(),t=0;t<=SCREEN_BOARD_X;t++)e.beginPath(),e.moveTo(t*BLOCK_CELL_SIZE,0),e.lineTo(t*BLOCK_CELL_SIZE,BLOCK_CELL_SIZE*SCREEN_BOARD_Y),e.closePath(),o.fillStroke(this);for(var l=0;l<=SCREEN_BOARD_Y;l++)e.beginPath(),e.moveTo(0,l*BLOCK_CELL_SIZE),e.lineTo(BLOCK_CELL_SIZE*SCREEN_BOARD_X,l*BLOCK_CELL_SIZE),e.closePath(),o.fillStroke(this)},stroke:BOARD_COLOR,strokeWidth:1});gBoardLayer.add(o)}function addBlock2Layer(o){createPolygon(gBlockGroup,0);for(var e=0;e<gPolyGroup.length;e++)gBoardLayer.add(gPolyGroup[e].poly)}function restoreBlock2Layer(o){clonePolygon(saveInfo.gPolyGroup,0);for(var e=0;e<gPolyGroup.length;e++){var t=gPolyGroup[e].poly;gBoardLayer.add(t),t.pos.x>0&&(t.setZIndex(gBlockUsed+1),clearShadow(t),setColor(t,1),gBlockCellUsed+=gPolyGroup[e].block.length,gBlockUsed++)}}function polyRegular(o){var e,t=o.length,l=0;hMode=0,vMode=2;for(var n=0;n<t-1;n++){e=-1;do{for(var r=n+1;r<t;r++)switch(l){case 0:o[n].y==o[r].y&&o[n].x<o[r].x&&(e<0||o[e].x>o[r].x)&&(e=r);break;case 1:o[n].y==o[r].y&&o[n].x>o[r].x&&(e<0||o[e].x<o[r].x)&&(e=r);break;case 2:o[n].x==o[r].x&&o[n].y>o[r].y&&(e<0||o[e].y<o[r].y)&&(e=r);break;case 3:o[n].x==o[r].x&&o[n].y<o[r].y&&(e<0||o[e].y>o[r].y)&&(e=r)}if(e<0)switch(l){case 0:hMode=++l;break;case 1:hMode=--l;break;case 2:vMode=++l;break;case 3:vMode=--l}}while(e<0);if(e!=n+1){var a=o[e];o[e]=o[n+1],o[n+1]=a}switch(l){case 0:case 1:l=vMode;break;case 2:case 3:l=hMode}}}function insert2Poly(o,e){var t=[{x:e.x,y:e.y},{x:e.x+1,y:e.y},{x:e.x,y:e.y+1},{x:e.x+1,y:e.y+1}];o:for(var l=0;l<4;l++){for(var n=0;n<o.length;n++)if(t[l].x==o[n].x&&t[l].y==o[n].y){o.splice(n,1);continue o}o.push({x:t[l].x,y:t[l].y})}}function block2Polygon(o){for(var e=[],t=[],l=0;l<o.length;l++)insert2Poly(e,o[l]);polyRegular(e);for(l=0;l<e.length;l++)t.push(e[l].x*BLOCK_CELL_SIZE),t.push(e[l].y*BLOCK_CELL_SIZE);return t}var lastFocusPolyId=-1;function getLastFocusPoly(){if(DEBUG&&console.log("lastFocusPolyId: "+lastFocusPolyId),!(lastFocusPolyId<0))return gPolyGroup[lastFocusPolyId].poly}function setFocusPoly(o){void 0!==o&&(o.setStroke(FOCUS_BORDER_COLOR),o.setStrokeWidth(2),o.moveToTop(),lastFocusPolyId=o.polyId)}function clearFocusPoly(o){void 0!==o&&(o.setStroke(BLOCK_BORDER_COLOR),o.setStrokeWidth(2),lastFocusPolyId=-1)}function setShadow(o){o.setShadowColor("black"),o.setShadowBlur(5),o.setShadowOffset([4,4]),o.setShadowOpacity(.8)}function clearShadow(o){o.setShadowColor("white"),o.setShadowBlur(0),o.setShadowOffset([0,0]),o.setShadowOpacity(0)}function block2OutlineShape(o,e,t,l,n){var r=block2Polygon(o);return new Kinetic.Shape({x:e,y:t,drawFunc:function(o){var e=o.getContext();e.beginPath(),e.moveTo(r[0],r[1]);for(var t=2;t<r.length;t+=2)e.lineTo(r[t],r[t+1]);e.lineTo(r[0],r[1]),e.closePath(),o.fillStroke(this)},stroke:l,strokeWidth:n})}function getPositionOfPoly(o,e,t,l){ry=-1;for(var n,r,a=0;a<SCREEN_BOARD_X&&(o<(n=boardStartX+a*BLOCK_CELL_SIZE)-10||o>n+10);a++);if(a>=SCREEN_BOARD_X)return{x:-1,y:-1};for(var i=0;i<SCREEN_BOARD_Y;i++)if(!(e<(r=boardStartY+i*BLOCK_CELL_SIZE)-10||e>r+10))return{x:a+1,y:i+1,boardX:n+t,boardY:r+l};return{x:-1,y:-1}}function removeBlock(o,e){removeBlockFromBoard(o,gPolyGroup[e.polyId].block,e.pos),setShadow(e),setColor(e,.8),e.pos.x=-1,gBlockCellUsed-=gPolyGroup[e.polyId].block.length,gBlockUsed--}function removeFromBoard(o){return o.pos.x>0?(removeBlock(gBoardState,o),removePolyIdFromInsertOrder(o.polyId),removeCheck(),1):0}function getCenterPos(o){var e,t,l,n;e=l=o[0].x,t=n=o[0].y;for(var r=1;r<o.length;r++)o[r].x<e&&(e=o[r].x),o[r].y<t&&(t=o[r].y),o[r].x>l&&(l=o[r].x),o[r].y>n&&(n=o[r].y);return{x:(1+l-e)/2,y:(1+n-t)/2}}function getLeftUpPos(o){var e=o[0].x;up=o[0].y;for(var t=1;t<o.length;t++)e>o[t].x&&(e=o[t].x),up>o[t].y&&(up=o[t].y);return{x:e,y:up}}function tryInsert2Board(o){var e,t,l,n=o.getRotationDeg()/90&1,r=getLeftUpPos(gPolyGroup[o.polyId].block);return n?(e=(o.centerPos.y+r.x)*BLOCK_CELL_SIZE,t=(o.centerPos.x+r.y)*BLOCK_CELL_SIZE):(e=(o.centerPos.x+r.x)*BLOCK_CELL_SIZE,t=(o.centerPos.y+r.y)*BLOCK_CELL_SIZE),(l=getPositionOfPoly(o.getPosition().x-e,o.getPosition().y-t,e,t)).x>0&&(DEBUG||console.log("linea 1356, llamamos a insertBlockToBoard() desde tryInsert2Board"),insertBlockToBoard(gBoardState,SCREEN_BOARD_X,SCREEN_BOARD_Y,gPolyGroup[o.polyId].block,l,o.blockId+1))?(o.pos=l,gBlockCellUsed+=gPolyGroup[o.polyId].block.length,gBlockUsed++,addPolyId2InsertOrder(o.polyId),1):0}function createPolygon(o,e){var t,l,n,r,a,i,d=0;for(gPolyGroup=[],t=0;t<o.length;t++)if(o[t].order>=0&&o[t].order<e)gBlockCellUsed+=o[t].blockStyle[0].length,gBlockUsed++;else{for(o[t].polyId=d,firstBlock=o[t].blockStyle[0],i=block2Polygon(firstBlock),gPolyGroup[d]={},gPolyGroup[d].block=[],l=0;l<firstBlock.length;l++)gPolyGroup[d].block[l]={},gPolyGroup[d].block[l].x=firstBlock[l].x,gPolyGroup[d].block[l].y=firstBlock[l].y;r=getLeftUpPos(gPolyGroup[d].block),n=getCenterPos(gPolyGroup[d].block),a=getPolyInitPos(d),gPolyGroup[d].poly=new Kinetic.Polygon({x:a.x,y:a.y,points:i,fill:colorSofter(o[t].color,.8),stroke:BLOCK_BORDER_COLOR,strokeWidth:2,offset:[(n.x+r.x)*BLOCK_CELL_SIZE,(n.y+r.y)*BLOCK_CELL_SIZE],dragBoundFunc:function(o){return checkPolyBound(this,o)}}),(i=gPolyGroup[d].poly).blockId=t,i.polyId=d,i.pos={x:-1,y:-1},i.centerPos=n,setShadow(i),d++}}function checkPolyBound(o,e){var t=e.x,l=e.y,n=o.getRotationDeg(),r=o.centerPos.x*BLOCK_CELL_SIZE,a=o.centerPos.y*BLOCK_CELL_SIZE;return n%180==0?(e.x<r+1&&(t=r+1),e.x>STAGE_X-r-5&&(t=STAGE_X-r-5),e.y<a+1&&(l=a+1),e.y>STAGE_Y-a-5&&(l=STAGE_Y-a-5)):(e.x<a+1&&(t=a+1),e.x>STAGE_X-a-5&&(t=STAGE_X-a-5),e.y<r+1&&(l=r+1),e.y>STAGE_Y-r-5&&(l=STAGE_Y-r-5)),{x:t,y:l}}function clonePolygon(o,e){var t,l,n;for(gPolyGroup=[],t=0;t<o.length;t++){for(gPolyGroup[t]={},gPolyGroup[t].block=[],l=0;l<o[t].block.length;l++)gPolyGroup[t].block[l]={},gPolyGroup[t].block[l].x=o[t].block[l].x,gPolyGroup[t].block[l].y=o[t].block[l].y;gPolyGroup[t].poly=new Kinetic.Polygon({x:o[t].poly.getX(),y:o[t].poly.getY(),points:o[t].poly.getPoints(),fill:o[t].poly.getFill(),stroke:o[t].poly.getStroke(),strokeWidth:o[t].poly.getStrokeWidth(),offset:o[t].poly.getOffset(),dragBoundFunc:function(o){return checkPolyBound(this,o)}}),(n=gPolyGroup[t].poly).blockId=o[t].poly.blockId,n.polyId=t,n.pos=o[t].poly.pos,n.centerPos=o[t].poly.centerPos;var r=o[t].poly.getScale();n.setScale(r.x,r.y),n.setRotationDeg(o[t].poly.getRotationDeg()),setShadow(n),n.hasRotate=o[t].poly.hasRotate,n.hasFlip=o[t].poly.hasFlip}}function activePolygon(){DEBUG2&&(console.log("linea 1499, gPolyGroup: "+gPolyGroup),console.log("linea 1500, gPolyGroup.length: "+gPolyGroup.length));for(var o=0;o<gPolyGroup.length;o++){var e=gPolyGroup[o].poly;e.setDraggable(!0),e.on("pointerover",function(){document.body.style.cursor="move"}),e.on("pointerout",function(){document.body.style.cursor="default"}),e.on("dragstart",function(){removeFromBoard(this),clearFocusPoly(getLastFocusPoly()),setFocusPoly(this),setShadow(this),gBoardLayer.draw()}),e.on("dragend",function(){tryInsert2Board(this)?(this.setX(this.pos.boardX),this.setY(this.pos.boardY),this.setZIndex(gBlockUsed+1),clearFocusPoly(this),hideOperatorObject(),clearShadow(this),setColor(this,1),gBoardLayer.draw(),insertCheck()):muestraBotonOperador(this)}),e.on("click",function(){clearFocusPoly(getLastFocusPoly()),hideOperatorObject(),removeFromBoard(this),setFocusPoly(this),setShadow(this),showOperatorObject(this),muestraBotonOperador(this)})}}function inactivePolygon(){for(var o=0;o<gPolyGroup.length;o++){var e=gPolyGroup[o].poly;e.setDraggable(!1),e.off("pointerover pointerout dragstart dragend click")}document.body.style.cursor="default"}var animateRotate90Object=new animateRotate90;function rotate90(o,e){var t=gPolyGroup[o.polyId].block;if(!animateRotate90Object.isRunning()){void 0===e&&(e=150),animateRotate90Object.init(o,e),animateRotate90Object.start();for(var l=0;l<t.length;l++){var n=t[l].x;t[l].x=-t[l].y,t[l].y=n}blockNormalization(t)}}function rotate90Running(){return animateRotate90Object.isRunning()}var rotateObject,flipObject,animateFlipObject=new animateLeftRightFlip;function leftRightFlip(o,e){DEBUG&&console.log("gPolyGroup[poly.polyId]: "+Object.values(gPolyGroup[o.polyId]));var t=gPolyGroup[o.polyId].block;if(!animateFlipObject.isRunning()){void 0===e&&(e=150),animateFlipObject.init(o,e),animateFlipObject.start();for(var l=0;l<t.length;l++)t[l].x=-t[l].x;blockNormalization(t)}}function leftRightFlipRunning(){return animateFlipObject.isRunning()}function rotateFocusPoly(){getLastFocusPoly().getRotationDeg()>=360&&getLastFocusPoly().setRotation(0),rotate90(getLastFocusPoly())}function flipFocusPoly(){leftRightFlip(getLastFocusPoly())}function createOperatorObject(){var o=BLOCK_CELL_SIZE/4;(rotateObject=new Kinetic.Shape({drawFunc:function(e){var t=e.getContext();t.beginPath(),t.arc(0,0,o,0,2*Math.PI,!1),t.fillStyle=OPERATOR_CIRCLE_COLOR,t.fill(),e.fill(this),t.beginPath(),t.globalAlpha=1,t.arc(0,0,o,1.3*Math.PI,2.1*Math.PI,!1),t.lineTo(2*o/3,-o/3),t.lineTo(o+o/10,-o/2.5),t.arc(0,0,o,2.1*Math.PI,2.1*Math.PI,!0),t.arc(0,0,o,2.1*Math.PI,1.3*Math.PI,!0),t.stroke(),e.fillStroke(this),t.beginPath(),t.arc(0,0,o,2.3*Math.PI,1.1*Math.PI,!1),t.lineTo(-2*o/3,o/3),t.lineTo(-o-o/10,+o/2.5),t.lineTo(-o,0),t.arc(0,0,o,1.1*Math.PI,1.1*Math.PI,!0),t.arc(0,0,o,1.1*Math.PI,2.3*Math.PI,!0),t.stroke(),e.fillStroke(this)},opacity:.3,stroke:OPERATOR_COLOR,strokeWidth:2})).on("pointerover",function(){document.body.style.cursor="pointer"}),rotateObject.on("pointerout",function(){document.body.style.cursor="default"}),rotateObject.on("click",function(){rotateFocusPoly()}),(flipObject=new Kinetic.Shape({drawFunc:function(e){var t=e.getContext();t.beginPath(),t.arc(0,0,o,0,2*Math.PI,!1),t.fillStyle=OPERATOR_CIRCLE_COLOR,t.fill(),e.fill(this),t.beginPath(),t.globalAlpha=1,t.lineTo(o/10,0),t.lineTo(4*o/5,0),t.lineTo(4*o/5,-o/5),t.lineTo(o+o/5,0),t.lineTo(4*o/5,o/5),t.lineTo(4*o/5,0),t.lineTo(o/10,0),t.fill(),e.fill(this),e.fillStroke(this),t.beginPath(),t.lineTo(-o/10,0),t.lineTo(-4*o/5,0),t.lineTo(-4*o/5,-o/5),t.lineTo(-o-o/5,0),t.lineTo(-4*o/5,+o/5),t.lineTo(-4*o/5,0),t.lineTo(-o/10,0),t.fill(),e.fill(this),e.fillStroke(this)},opacity:.3,stroke:OPERATOR_COLOR,strokeWidth:2})).on("pointerover",function(){document.body.style.cursor="pointer"}),flipObject.on("pointerout",function(){document.body.style.cursor="default"}),flipObject.on("click",function(){flipFocusPoly()})}var rotateOperatorStatus=0,flipOperatorStatus=0;function addOperator2Layer(){gBoardLayer.add(rotateObject),gBoardLayer.add(flipObject),rotateObject.hide(),flipObject.hide(),rotateOperatorStatus=0,flipOperatorStatus=0}function showOperatorObject(o){console.log("----\tfunction showOperatorObject(poly)\t");var e=o.getPosition().x,t=o.getPosition().y;o.hasRotate&&(rotateObject.show(),rotateObject.setX(e),rotateObject.setY(t),rotateObject.moveToTop(),rotateOperatorStatus=1),o.hasFlip&&(flipObject.show(),flipObject.setX(e),flipObject.setY(t-2*BLOCK_CELL_SIZE/3),flipObject.moveToTop(),flipOperatorStatus=1),gBoardLayer.draw()}function hideOperatorObject(){rotateOperatorStatus&&rotateObject.hide(),flipOperatorStatus&&flipObject.hide(),rotateOperatorStatus=0,flipOperatorStatus=0}function findAnswer(o,e){var t,l,n,r={rotate:0,leftRightFlip:0,upDownFlip:0},a=screenBoard2AnswerBoard(o,r),i=new polySolution;return e?setBlockInUsed():clearBlockInUsed(),r.rotate?(l=SCREEN_BOARD_Y,n=SCREEN_BOARD_X):(l=SCREEN_BOARD_X,n=SCREEN_BOARD_Y),i.init(a,l,n,1,gBlockGroup,1),(t=i.find()).totalAnswer>0&&(t.solvedBoard=dupAnswerBoard2ScreenBoard(t.solvedBoard[0],r),t.op=r),t}function screenBoard2AnswerBoard(o,e){var t,l=o.length,n=o[0].length,r=rightCellCount=upCellCount=downCellCount=0;l>n?(e.rotate=1,l=(t=rotateBoard(o)).length,n=t[0].length):t=dupBoard(o);for(var a=l/2,i=n/2,d=1;d<l;d++)for(var c=1;c<=n;c++)t[d][c]&&(d<a?r++:rightCellCount++,c<i?upCellCount++:downCellCount++);return upCellCount<downCellCount&&(e.upDownFlip=1,t=upDownFlipBoard(t)),r<rightCellCount&&(e.leftRightFlip=1,t=leftRightFlipBoard(t)),t}function dupBoard(o){for(var e=o.length,t=o[0].length,l=[],n=0;n<e;n++){l[n]=[];for(var r=0;r<t;r++)l[n][r]=o[n][r]}return l}function rotateBoard(o){for(var e=o.length,t=o[0].length,l=[],n=0;n<t;n++){l[n]=[];for(var r=0;r<e;r++)l[n][r]=o[r][n]}return l}function upDownFlipBoard(o){for(var e=o.length,t=o[0].length,l=[],n=0;n<e;n++){l[n]=[];for(var r=0;r<t;r++)l[n][r]=o[n][t-r-1]}return l}function leftRightFlipBoard(o){for(var e=o.length,t=o[0].length,l=[],n=0;n<e;n++){l[n]=[];for(var r=0;r<t;r++)l[n][r]=o[e-n-1][r]}return l}function dupAnswerBoard2ScreenBoard(o,e){return e.leftRightFlip&&(o=leftRightFlipBoard(o)),e.upDownFlip&&(o=upDownFlipBoard(o)),e.rotate&&(o=rotateBoard(o)),o}function clearBlockInUsed(){for(var o=0;o<gBlockGroup.length;o++)gBlockGroup[o].blockUsed=0}function setBlockInUsed(){for(var o=0;o<gBlockGroup.length;o++)gBlockGroup[o].polyId<0?gBlockGroup[o].blockUsed=1:gBlockGroup[o].blockUsed=0;for(o=0;o<gPolyGroup.length;o++){var e=gPolyGroup[o].poly;e.pos.x>0?gBlockGroup[e.blockId].blockUsed=1:gBlockGroup[e.blockId].blockUsed=0}}var polyIdOrder,checkSolution=!1;function insertCheck(){if(DEBUG2&&(console.log("linea 2129, gBlockCellUsed: "+gBlockCellUsed),console.log("linea 2130, gTotalBlockCell: "+gTotalBlockCell)),gBlockCellUsed>=gTotalBlockCell)return inactivePolygon(),disableAllButton(),setTimeout(function(){writeFinishMsg()},500),void(sloveState=1);DEBUG2&&console.log("linea 2143, checkSolution: "+checkSolution),checkSolution&&check()}function removeCheck(){writeMessage(""),checkSolution&&check()}function check(){var o=findAnswer(gBoardState,1);return o.totalAnswer<=0?writeMessage(noSolutionText):writeMessage(""),o.totalAnswer}function checkButton(o){checkSolution=o,writeMessage(""),gBlockCellUsed>=gTotalBlockCell||checkSolution&&check()}function clearPolyInsertOrder(){polyIdOrder=[]}function addPolyId2InsertOrder(o){polyIdOrder.push(o)}function removePolyIdFromInsertOrder(o){for(var e=0;e<polyIdOrder.length;e++)if(polyIdOrder[e]==o){polyIdOrder.splice(e,1);break}}function getPolyIdFromInsertOrder(){return polyIdOrder.pop()}function hintsButton(){var o,e,t,l=350;if(!(gBlockCellUsed>=gTotalBlockCell)){for(o=findAnswer(gBoardState,1);o.totalAnswer<=0;)t=getPolyIdFromInsertOrder(),DEBUG&&(console.log("linea 2223, polyId: "+t),console.log("gPolyGroup[polyId]: "+gPolyGroup[t]),console.log("            result: "+o),console.log("result.solvedBoard: "+o.solvedBoard),console.log("\t      result.op; "+o.op)),e=gPolyGroup[t].poly,removeBlock(gBoardState,e),o=findAnswer(gBoardState,1);writeMessage(""),clearFocusPoly(getLastFocusPoly()),hideOperatorObject(),disableAllButton(),animateBlockBack(l)||(l=0),enableButtonAfterStopRunning(animateHintsBlock(o.solvedBoard,o.op,l))}}function disableAllButton(){document.getElementById("hintsButton").disabled=!0,document.getElementById("newButton").disabled=!0,document.getElementById("resetButton").disabled=!0,document.getElementById("giraPieza").disabled=!0,document.getElementById("volteaPieza").disabled=!0,document.getElementById("checkButton").disabled=!0}function visibleStartButton(){document.getElementById("startButton").disabled=!1,document.getElementById("startButton").style.visibility="visible"}function hiddenStartButton(){document.getElementById("startButton").disabled=!0,document.getElementById("startButton").style.visibility="hidden"}function enableAllButton(){document.getElementById("hintsButton").disabled=!1,document.getElementById("newButton").disabled=!1,document.getElementById("resetButton").disabled=!1,document.getElementById("giraPieza").disabled=!1,document.getElementById("volteaPieza").disabled=!1,document.getElementById("checkButton").disabled=!1}function visibleAllButton(){document.getElementById("hintsButton").style.visibility="visible",document.getElementById("newButton").style.visibility="visible",document.getElementById("resetButton").style.visibility="visible",document.getElementById("giraPieza").style.visibility="visible",document.getElementById("volteaPieza").style.visibility="visible",document.getElementById("checkButton").style.visibility="visible",document.getElementById("checkboxtext").style.visibility="visible"}function hiddenAllButton(){document.getElementById("hintsButton").style.visibility="hidden",document.getElementById("newButton").style.visibility="hidden",document.getElementById("resetButton").style.visibility="hidden",document.getElementById("giraPieza").style.visibility="hidden",document.getElementById("volteaPieza").style.visibility="hidden",document.getElementById("checkButton").style.visibility="hidden",document.getElementById("checkboxtext").style.visibility="hidden"}function animateBlockBack(o){for(var e,t,l=0,n=0;n<gPolyGroup.length;n++)(e=gPolyGroup[n].poly).pos.x>0||(t=getPolyInitPos(n),Math.round(e.getX())==t.x&&Math.round(e.getY())==t.y||(e.moveToTop(),e.transitionTo({x:t.x,y:t.y,duration:o/1e3}),l++));return l}function animateHintsBlock(o,e,t){var l;if(DEBUG2)for(var n=0;n<gBlockGroup.length;n++)console.log("gBlockGroup ["+n+"] polyId\t : "+gBlockGroup[n].polyId);var r=findAvailableBlock(o),a=boardStartX+r.x*BLOCK_CELL_SIZE,i=boardStartY+r.y*BLOCK_CELL_SIZE,d=r.id;DEBUG||(console.log("linea 2397, result.id: "+r.id),console.log("linea 2398, result: x * y * id : "+r.x+" * "+r.y+" * "+r.id));var c=block2OutlineShape(dupOpBlock(gBlockGroup[d].blockStyle[gBlockGroup[d].usedStyle],e,1),a,i,FLASH_BORDER_COLOR,4);return(l=new animateFlash).init(c,gBoardLayer,t,3),l.start(),l}function findAvailableBlock(o){var e,t,l=Math.floor(2*Math.random()),n=o.length-1,r=o[0].length-1;if(DEBUG2&&console.log("linea 2427, findAvailableBlock(solvedBoard)"),l){o:for(var a=1;a<n;a++)for(var i=1;i<r;i++)if(e=o[a][i]-1,DEBUG2&&console.log("linea 2435, blockId : "+e),e<90&&(t=gBlockGroup[e].polyId)>=0&&gPolyGroup[t].poly.pos.x<0)break o;o:for(i=1;i<r;i++)for(a=1;a<n;a++)if(o[a][i]-1==e)break o}else o:for(i=1;i<r;i++)for(a=1;a<n;a++)if(e=o[a][i]-1,DEBUG2&&(console.log("linea 2470, x, y : "+a+" - "+i),console.log("linea 2471, blockId : "+e)),e<90&&(t=gBlockGroup[e].polyId)>=0&&gPolyGroup[t].poly.pos.x<0)break o;return DEBUG||console.log("linea 2491, x-1, y-1, blockId: "+a-1+" - "+i-1+" - "+e),{x:a-1,y:i-1,id:e}}function enableButtonAfterStopRunning(o,e){o.isRunning()?setTimeout(function(){enableButtonAfterStopRunning(o,e)},200):(delete o,enableAllButton())}function resetButton(){for(var o,e;polyIdOrder.length>0;)e=polyIdOrder.pop(),o=gPolyGroup[e].poly,removeBlock(gBoardState,o);writeMessage(""),clearFocusPoly(getLastFocusPoly()),hideOperatorObject(),animateBlockBack(350)&&(disableAllButton(),setTimeout("enableAllButton();",360))}var boardSizeInfo=[{x:6,y:5,numOfLevel:3},{x:8,y:5,numOfLevel:3},{x:10,y:5,numOfLevel:4},{x:10,y:6,numOfLevel:4}];function writeFinishMsg(){var o=Math.floor((STAGE_X-10)/(12*finishText.length)),e=Math.floor(STAGE_Y/3/26),t=new Kinetic.Text({x:STAGE_X/2-12*finishText.length/2,y:STAGE_Y/2-13,text:finishText,fontSize:26,fontStyle:"bold",fill:TEXT_FINISH_COLOR,shadowColor:"black",shadowBlur:1,shadowOffset:[8,8],shadowOpacity:.5});gBoardLayer.add(t),t.transitionTo({x:STAGE_X/2-12*finishText.length*o/2,y:STAGE_Y/2-26*e/2,scale:{x:o,y:e},duration:1,easing:"elastic-ease-in-out"}),setTimeout("nextButton();",600)}function nextButton(){var o=16*nextText.length+16,e=Math.floor(STAGE_X/o/4),t=Math.floor(STAGE_Y/16/8),l=3*STAGE_X/4,n=4*STAGE_Y/5,r=new Kinetic.Text({x:l-o/2,y:n-16,text:nextText,fill:NEXT_BUTTON_TEXT_COLOR,fontSize:16,align:"center",width:o,padding:8,stroke:NEXT_BUTTON_TEXT_COLOR,strokeWidth:1}),a=new Kinetic.Rect({x:l-o/2,y:n-16,stroke:NEXT_BUTTON_BORDER_COLOR,strokeWidth:7,fill:NEXT_BUTTON_FILL_COLOR,width:o,height:r.getHeight(),shadowColor:"black",shadowBlur:10,shadowOffset:[30,30],shadowOpacity:.5,cornerRadius:5}),i=new Kinetic.Group;i.add(a),i.add(r),gBoardLayer.add(i),a.transitionTo({x:l-o*e/2,y:n-32*t/2,scale:{x:e,y:t},duration:1.5,easing:"elastic-ease-out"}),r.transitionTo({x:l-o*e/2,y:n-32*t/2,scale:{x:e,y:t},duration:1.5,easing:"elastic-ease-out"}),i.on("pointerover",function(){document.body.style.cursor="pointer"}),i.on("pointerout",function(){document.body.style.cursor="default"}),i.on("click",function(){setNextLevel(),createPuzzle(1,!0),enableAllButton()})}function setNextLevel(){++gLevelId>boardSizeInfo[gBoardSizeId].numOfLevel&&(gLevelId=1,++gBoardSizeId>=boardSizeInfo.length&&(gBoardSizeId=0)),saveBoardSize(gBoardSizeId,gLevelId)}function colorSofter(o,e){var t=255*(1-e);return"#"+("0"+Math.round(parseInt(o.substr(1,2),16)*e+t).toString(16)).slice(-2)+("0"+Math.round(parseInt(o.substr(3,2),16)*e+t).toString(16)).slice(-2)+("0"+Math.round(parseInt(o.substr(5,2),16)*e+t).toString(16)).slice(-2)}function setColor(o,e){var t=colorSofter(gBlockGroup[o.blockId].color,e);o.setFill(t)}function saveBoardSize(o,e){setStorage("polyBoardSize",o),setStorage("polyLevel",e)}function restoreBoardSize(){var o=parseInt(getStorage("polyBoardSize")),e=parseInt(getStorage("polyLevel"));(isNaN(o)||isNaN(e)||o<0||o>=boardSizeInfo.length||e<0||e>boardSizeInfo[o].numOfLevel)&&(o=0,e=1),initBoardSize(o,e)}function setStorage(o,e){void 0!==window.localStorage&&window.localStorage.setItem(o,e)}function getStorage(o){var e=null;return void 0!==window.localStorage&&(e=window.localStorage.getItem(o)),e}function clearStorage(o){void 0!==window.localStorage&&window.localStorage.removeItem(o)}function getSystemLanguage(){return(window.navigator.userLanguage||window.navigator.language).toLowerCase()}function writeMessage(o){var e=gMessageLayer.getContext();gMessageLayer.clear(),e.font="28pt arial",e.fillStyle="maroon",e.fillText(o,STAGE_X/2-9.5*o.length,STAGE_Y/2+BLOCK_CELL_SIZE*(SCREEN_BOARD_Y/2)),gBoardLayer.draw()}function dumpBoard(o){for(var e=o.length,t=o[0].length,l=0;l<t;l++){"";for(var n=0;n<e;n++)o[n][l]>9?o[n][l]+" ":"0"+o[n][l]+" "}}function wAgregaCuadrominoFijo(o){var e;DEBUG2&&(console.log("linea 2849, Ingresando a wAgregaCuadrominoFijo(pos)"),console.log("linea 2850, pos.x: "+o.x),console.log("linea 2851, pos.y: "+o.y),console.log("linea 2852, wCuadromGroup[nCuadromId].blockStyle[0]: "+wCuadromGroup[nCuadromId].blockStyle[0][0]));var t=0,l=dupOpBlock(wCuadromGroup[nCuadromId].blockStyle[0],0,0),n=block2Polygon(l);DEBUG2&&console.log("linea 2865, wAgregaCuadromino fijo, poly: "+n);var r=getLeftUpPos(l),a=getCenterPos(l),i=a.x+r.x,d=a.y+r.y,c=boardStartX+(o.x-1+i)*BLOCK_CELL_SIZE,s=boardStartY+(o.y-1+d)*BLOCK_CELL_SIZE;if(gFixedPolyGroup[t]={},gFixedPolyGroup[t].block=l,e=new Kinetic.Polygon({x:c,y:s,offset:[i*BLOCK_CELL_SIZE,d*BLOCK_CELL_SIZE],points:n,fill:FIXED_BLOCK_COLOR,stroke:FIXED_BORDER_COLOR,strokeWidth:2}),gFixedPolyGroup[t].poly=e,gBlockCellUsed+=gFixedPolyGroup[t].block.length,gBlockUsed++,gBoardLayer.add(e),DEBUG2&&(console.log("gBoardState----\x3e"),dumpBoard(gBoardState),console.log("linea 2909, pos           : "+o.x+" , "+o.y)),DEBUG2&&console.log("linea 2916, llamamos a insertBlockToBoard() desde wAgregaCuadrominoFijo(pos)\t"),!insertBlockToBoard(gBoardState,SCREEN_BOARD_X,SCREEN_BOARD_Y,l,o,99))throw dumpBoard(gBoardState),new Error("Design error");t++}function wCreateCuadrado(o,e){var t,l,n,r,a=0;gBlockCellUsed+=o[id].blockStyle[0].length,gBlockUsed++,DEBUG&&(console.log("linea 2888, blockGroup    : "+o),console.log("linea 2889, blockGroup[0]: "+o[0]),console.log("linea 2830, blockGroup[0].blockStyle.x: "+o[0].blockStyle.x)),r=block2Polygon(o[0].blockStyle),l=getLeftUpPos(gPolyGroup[a].block),t=getCenterPos(gPolyGroup[a].block),n=getPolyInitPos(a),gPolyGroup[a].poly=new Kinetic.Polygon({x:n.x,y:n.y,points:r,fill:colorSofter(o.color,.8),stroke:BLOCK_BORDER_COLOR,strokeWidth:2,offset:[(t.x+l.x)*BLOCK_CELL_SIZE,(t.y+l.y)*BLOCK_CELL_SIZE],dragBoundFunc:function(o){return checkPolyBound(this,o)}}),(r=gPolyGroup[a].poly).blockId=0,r.polyId=a,r.pos={x:-1,y:-1},r.centerPos=t,setShadow(r),r.hasRotate=1!=o.blockStyle.length,r.hasFlip=o.hasFlip,a++}function addBlock2Layer(o){createPolygon(gBlockGroup,0);for(var e=0;e<gPolyGroup.length;e++)gBoardLayer.add(gPolyGroup[e].poly)}function CalcCeldasOcupadas(){var o=[];DEBUG2&&(console.log("linea 3025, wCuadromPos: "+wCuadromPos),console.log("linea 3026, wCuadromGroup[nCuadromId].blockStyle "+wCuadromGroup[nCuadromId].blockStyle),console.log("linea 3027, wCuadromGroup[nCuadromId].blockStyle[0] "+wCuadromGroup[nCuadromId].blockStyle[0]),console.log("linea 3027, wCuadromGroup[nCuadromId].blockStyle[0][0] "+wCuadromGroup[nCuadromId].blockStyle[0][0]),console.log("linea 3027, wCuadromGroup[nCuadromId].blockStyle[0][0].x "+wCuadromGroup[nCuadromId].blockStyle[0][0].x),console.log("linea 3029, wCuadromPos[0].x "+wCuadromPos.x),console.log("linea 3030, wCuadromGroup[nCuadromId].blockStyle[0][0].y "+wCuadromGroup[nCuadromId].blockStyle[0][0].y),console.log("linea 3031, wCuadromPos[0].y "+wCuadromPos.y));for(var e=0;e<wCuadromGroup[nCuadromId].blockStyle[0].length;e++)o[e]={},o[e].x=wCuadromGroup[nCuadromId].blockStyle[0][e].x+wCuadromPos.x,o[e].y=wCuadromGroup[nCuadromId].blockStyle[0][e].y+wCuadromPos.y;return o}function muestraBotonOperador(o){o.getPosition().x,o.getPosition().y;o.hasRotate&&(document.getElementById("giraPieza").disabled=!1,document.getElementById("giraPieza").style.visibility="visible"),o.hasFlip&&(document.getElementById("volteaPieza").disabled=!1,document.getElementById("volteaPieza").style.visibility="visible"),gBoardLayer.draw()}function ocultaBotonOperador(){}function giraPieza(){DEBUG&&console.log("lastFocusPolyId: "+lastFocusPolyId),lastFocusPolyId<0||(getLastFocusPoly().getRotationDeg()>=360&&getLastFocusPoly().setRotation(0),rotate90(getLastFocusPoly()))}function volteaPieza(){DEBUG&&console.log("lastFocusPolyId: "+lastFocusPolyId),lastFocusPolyId<0||leftRightFlip(getLastFocusPoly())}function addContorno2Layer(){var o=canvas.getContext();o.fillStyle="#FF0000",o.fillRect(STAGE_X,STAGE_Y,STAGE_OFFSET_X,STAGE_OFFSET_Y)}